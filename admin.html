<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель — Смерть от неизбежности</title>
    <style>
        /* Твой старый стиль — без изменений */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Georgia', serif; background:#000 url('bg.gif') no-repeat center center fixed; background-size:cover; color:#d0d0d8; min-height:100vh; font-size:15px; line-height:1.45; }
        body::before { content:''; position:fixed; inset:0; background:rgba(0,0,0,0.68); z-index:-2; pointer-events:none; }
        .navbar { background:rgba(6,6,14,0.88); backdrop-filter:blur(10px); border-bottom:1px solid rgba(50,50,80,0.25); padding:8px 20px; position:sticky; top:0; z-index:1000; display:flex; justify-content:space-between; align-items:center; }
        .clan-name { font-family:'Arial Black',Arial,sans-serif; font-size:1.45rem; color:#b8b8c8; text-shadow:0 0 12px rgba(140,140,180,0.3); letter-spacing:1.5px; }
        .right-side { display:flex; align-items:center; gap:10px; }
        .user-info { font-size:0.85rem; color:#a0a0b8; }
        .button { padding:6px 14px; background:rgba(16,16,30,0.75); color:#d0d0d8; border:1px solid rgba(60,60,90,0.35); border-radius:6px; font-weight:600; font-size:0.82rem; cursor:pointer; transition:all 0.25s; text-decoration:none; }
        .button:hover { background:rgba(35,35,55,0.95); border-color:#a0a0c0; color:#f8f8ff; }
        .logout:hover { background:rgba(60,15,15,0.95); border-color:#a03030; }
        .container { max-width:960px; width:94%; margin:30px auto; padding:0 15px; }
        .card { background:rgba(8,8,18,0.78); backdrop-filter:blur(12px); border:1px solid rgba(60,60,90,0.25); border-radius:12px; padding:24px 20px; box-shadow:0 10px 40px rgba(0,0,0,0.7); }
        h1 { color:#c0c0d8; text-align:center; font-size:2.1rem; text-shadow:0 0 16px rgba(160,160,200,0.25); margin-bottom:16px; }
        .section { margin: 30px 0; padding: 20px; background: rgba(12,12,25,0.7); border: 1px solid rgba(60,60,90,0.4); border-radius: 10px; }
        .section h2 { margin-bottom: 16px; color: #c0c0e8; }
        .keys-list { display: grid; gap: 12px; }
        .key-item { display: flex; justify-content: space-between; align-items: center; background: rgba(8,8,18,0.8); padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(60,60,90,0.5); }
        .key-text { font-family: monospace; font-size: 1.1rem; color: #ffd700; }
        .delete-key-btn { background: rgba(80,20,20,0.8); color: #ff9090; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; }
        .delete-key-btn:hover { background: #a02020; color: white; }
        .create-key-btn { display: block; margin: 20px auto; padding: 12px 32px; background: #2a602a; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .create-key-btn:hover { background: #3a803a; }
        .check-tasks-btn { display: block; margin: 0 auto 32px; padding: 14px 36px; font-size: 1.1rem; background: linear-gradient(135deg, #2a4a6a, #3a5a7a); border: 1px solid rgba(100,140,200,0.5); border-radius: 8px; color: #f0f8ff; font-weight: bold; text-decoration: none; transition: all 0.25s; }
        .check-tasks-btn:hover { background: linear-gradient(135deg, #3a5a7a, #4a6a8a); box-shadow: 0 0 20px rgba(100,140,200,0.4); transform: translateY(-2px); }
        .player-list { margin-top:20px; display:grid; gap:14px; }
        .player-item { background:rgba(12,12,25,0.7); padding:16px 20px; border-radius:8px; border:1px solid rgba(60,60,90,0.3); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
        .player-info { flex:1; }
        .player-nick { font-weight:bold; color:#c0c0e8; font-size:1.15rem; }
        .player-date { font-size:0.88rem; color:#9090b0; margin-top:4px; }
        .player-poroh { font-size:1rem; color:#ffd700; font-weight:bold; margin-left:12px; }
        .actions { display:flex; gap:10px; flex-wrap:wrap; }
        .delete-btn, .give-poroh-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:0.9rem; }
        .delete-btn { background:rgba(80,20,20,0.8); color:#ff9090; }
        .delete-btn:hover { background:#a02020; color:white; }
        .give-poroh-btn { background:rgba(100,80,0,0.8); color:#ffdd88; }
        .give-poroh-btn:hover { background:rgba(140,110,0,0.95); color:white; }
        .back-link { display:block; margin:30px auto 0; text-align:center; color:#a0a0c0; text-decoration:none; font-size:0.95rem; }
        .back-link:hover { color:#d0d0e8; text-decoration:underline; }
        /* Модалка выдачи Пороха */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(6px); align-items:center; justify-content:center; z-index:2000; }
        .modal-content { background:rgba(12,12,25,0.95); border:1px solid rgba(80,80,120,0.5); border-radius:12px; padding:24px; width:360px; max-width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.8); }
        .modal-title { font-size:1.3rem; margin-bottom:16px; color:#ffd700; }
        .modal-input { width:100%; padding:10px; margin:12px 0; background:rgba(8,8,18,0.8); border:1px solid #606080; border-radius:6px; color:#e0e0f0; font-size:1rem; }
        .modal-buttons { display:flex; gap:12px; margin-top:20px; }
        .modal-btn { flex:1; padding:10px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
        .confirm { background:#2a602a; color:white; }
        .confirm:hover { background:#3a803a; }
        .cancel { background:#602a2a; color:white; }
        .cancel:hover { background:#803a3a; }
    </style>
</head>
<body>

    <nav class="navbar">
        <h1 class="clan-name">Смерть от неизбежности</h1>
        <div class="right-side">
            <span id="userInfo" class="user-info"></span>
            <button class="button" onclick="window.location.href='index.html'">На главную</button>
            <button id="logoutBtn" class="button logout">Выйти</button>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h1>Админ-панель</h1>

            <!-- Кнопка проверки заданий -->
            <a href="admin-tasks.html" class="check-tasks-btn">
                → Проверка заданий (одобрение + начисление Пороха)
            </a>

            <!-- Секция ключей приглашения -->
            <div class="section">
                <h2>Ключи приглашения</h2>
                <button class="create-key-btn" onclick="createInviteKey()">Создать новый ключ</button>
                <div id="keysList" class="keys-list"></div>
            </div>

            <div class="player-list" id="playerList"></div>

            <a href="profile.html" class="back-link">← вернуться в свой профиль</a>
        </div>
    </div>

    <!-- Модалка выдачи Пороха -->
    <div id="porohModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Выдать Порох</div>
            <input type="number" id="porohAmount" class="modal-input" placeholder="Сколько Пороха выдать" min="1" step="1">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePorohModal()">Отмена</button>
                <button class="modal-btn confirm" onclick="confirmGivePoroh()">Выдать</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            deleteDoc, 
            updateDoc, 
            getDoc, 
            query, 
            where 
        } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJYlZefVTt-hV0TYpJwR4TeFSE9tL7LBs",
            authDomain: "smert-neizbezhnost-5bed1.firebaseapp.com",
            projectId: "smert-neizbezhnost-5bed1",
            storageBucket: "smert-neizbezhnost-5bed1.firebasestorage.app",
            messagingSenderId: "189599859406",
            appId: "1:189599859406:web:a7012bf4c5bd06161ec69f",
            measurementId: "G-EK917724G4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let selectedUserUid = null;

        // Проверка админа
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('Сначала войди');
                window.location.href = 'index.html';
                return;
            }

            const adminDoc = await getDoc(doc(db, "users", user.uid));
            if (!adminDoc.exists() || (!adminDoc.data().isAdmin && adminDoc.data().nick.toLowerCase() !== 'admin')) {
                alert('Доступ запрещён. Только для администратора.');
                window.location.href = 'profile.html';
                return;
            }

            document.getElementById('userInfo').textContent = `Админ: ${adminDoc.data().nick}`;

            renderKeys();
            renderPlayers();
        });

        // Генерация случайного ключа
        function generateKey(length = 12) {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let key = '';
            for (let i = 0; i < length; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return key;
        }

        // Создать новый ключ
        window.createInviteKey = async () => {
            const newKey = generateKey();
            try {
                await addDoc(collection(db, "inviteKeys"), {
                    key: newKey,
                    used: false,
                    createdAt: new Date().toISOString()
                });
                alert(`Новый ключ создан: ${newKey}\nСкопируй его и разошли приглашённым!`);
                renderKeys();
            } catch (error) {
                alert('Ошибка при создании ключа: ' + error.message);
            }
        };

        // Удалить ключ
        window.deleteKey = async (keyId) => {
            if (!confirm(`Удалить ключ?`)) return;
            try {
                await deleteDoc(doc(db, "inviteKeys", keyId));
                renderKeys();
            } catch (error) {
                alert('Ошибка при удалении: ' + error.message);
            }
        };

        // Отрисовка ключей
        async function renderKeys() {
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = '';

            const querySnapshot = await getDocs(collection(db, "inviteKeys"));
            if (querySnapshot.empty) {
                keysList.innerHTML = '<p style="text-align:center; color:#707090;">Нет ключей. Создай первый!</p>';
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const item = document.createElement('div');
                item.className = 'key-item';
                item.innerHTML = `
                    <span class="key-text">${data.key} ${data.used ? '(использован)' : ''}</span>
                    <button class="delete-key-btn" onclick="deleteKey('${docSnap.id}')">Удалить</button>
                `;
                keysList.appendChild(item);
            });
        }

        // Отрисовка игроков
        async function renderPlayers() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';

            const q = query(collection(db, "users"), orderBy("registered", "asc"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                playerList.innerHTML = '<p style="text-align:center; color:#707090;">Никто не зарегистрирован</p>';
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const u = docSnap.data();
                const isCurrent = u.uid === auth.currentUser.uid;
                const isMainAdmin = u.nick.toLowerCase() === 'admin';

                const item = document.createElement('div');
                item.className = 'player-item';

                const info = document.createElement('div');
                info.className = 'player-info';
                info.innerHTML = `
                    <div class="player-nick">${u.nick}</div>
                    <div class="player-date">Присоединился: ${new Date(u.registered).toLocaleDateString('ru-RU')}</div>
                    <div class="player-poroh">Порох: ${u.poroh || 0}</div>
                `;

                const actions = document.createElement('div');
                actions.className = 'actions';

                if (!isCurrent) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Удалить';
                    delBtn.disabled = isMainAdmin;
                    delBtn.onclick = async () => {
                        if (isMainAdmin) {
                            alert('Главного администратора удалить нельзя');
                            return;
                        }
                        if (!confirm(`Удалить ${u.nick} навсегда?`)) return;
                        try {
                            await deleteDoc(doc(db, "users", docSnap.id));
                            renderPlayers();
                        } catch (error) {
                            alert('Ошибка при удалении: ' + error.message);
                        }
                    };
                    actions.appendChild(delBtn);

                    const giveBtn = document.createElement('button');
                    giveBtn.className = 'give-poroh-btn';
                    giveBtn.textContent = 'Выдать Порох';
                    giveBtn.onclick = () => {
                        selectedUserUid = docSnap.id;
                        document.getElementById('modalTitle').textContent = `Выдать Порох игроку ${u.nick}`;
                        document.getElementById('porohModal').style.display = 'flex';
                    };
                    actions.appendChild(giveBtn);
                }

                item.appendChild(info);
                item.appendChild(actions);
                playerList.appendChild(item);
            });
        }

        // Модалка Пороха
        function closePorohModal() {
            document.getElementById('porohModal').style.display = 'none';
            document.getElementById('porohAmount').value = '';
            selectedUserUid = null;
        }

        document.getElementById('porohModal').addEventListener('click', e => {
            if (e.target === document.getElementById('porohModal')) closePorohModal();
        });

        window.confirmGivePoroh = async () => {
            if (!selectedUserUid) return;

            const amount = parseInt(document.getElementById('porohAmount').value);
            if (isNaN(amount) || amount <= 0) {
                alert('Введите положительное число!');
                return;
            }

            try {
                const userRef = doc(db, "users", selectedUserUid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const currentPoroh = userSnap.data().poroh || 0;
                    await updateDoc(userRef, {
                        poroh: currentPoroh + amount
                    });
                    alert(`Выдано ${amount} Пороха.\nТеперь у игрока: ${currentPoroh + amount}`);
                    closePorohModal();
                    renderPlayers();
                } else {
                    alert('Игрок не найден');
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        };

        // Выход
        document.getElementById('logoutBtn').onclick = async () => {
            await signOut(auth);
            alert('Вы вышли');
            window.location.href = 'index.html';
        };
    </script>
</body>
</html>